#! /usr/bin/ruby

#--
###############################################################################
#                                                                             #
# hen -- Just a Rake helper                                                   #
#                                                                             #
# Copyright (C) 2007-2008 University of Cologne,                              #
#                         Albertus-Magnus-Platz,                              #
#                         50932 Cologne, Germany                              #
#                                                                             #
# Authors:                                                                    #
#     Jens Wille <jens.wille@uni-koeln.de>                                    #
#                                                                             #
# hen is free software; you can redistribute it and/or modify it under the    #
# terms of the GNU General Public License as published by the Free Software   #
# Foundation; either version 3 of the License, or (at your option) any later  #
# version.                                                                    #
#                                                                             #
# hen is distributed in the hope that it will be useful, but WITHOUT ANY      #
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS   #
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more       #
# details.                                                                    #
#                                                                             #
# You should have received a copy of the GNU General Public License along     #
# with hen. If not, see <http://www.gnu.org/licenses/>.                       #
#                                                                             #
###############################################################################
#++

# TODO: Add 'list' - List available hens with their tasks (?)

$: << File.join(File.dirname(__FILE__), '..', 'lib')

require 'hen'
require 'hen/cli'

include Hen::CLI

ACTIONS = {
  'config' => 'Create a fresh .henrc file',
  'create' => 'Create a new project directory tree',
  'list'   => 'List available hens with their tasks'
}

USAGE = <<EOT
Usage: #{$0} {#{ACTIONS.keys.sort.join('|')}}
       #{$0} [-h|--help]
EOT

abort USAGE if ARGV.empty?

EXAMPLE = File.join(File.dirname(__FILE__), '..', 'example')

case action = ARGV.shift
  when '-h', '--help'
    puts USAGE
    puts
    puts 'Actions:'

    m = ACTIONS.keys.map { |a| a.length }.max

    ACTIONS.sort.each { |a, d|
      puts "  %-#{m}s - %s" % [a, d]
    }
  when 'config'
    henrc = File.join(EXAMPLE, '.henrc')

    # TODO: DRY up with lib/hen.rb
    target = File.join(ENV['HOME'] || File.expand_path('~'), '.henrc')

    render(henrc, target)

    puts
    puts "Your .henrc has been created: #{target}. Modify to your needs."
  when 'create'
    path = File.expand_path(ARGV.shift)
    abort 'Path argument missing!' unless path

    template = File.join(EXAMPLE, 'project')
    abort "Sample project tree not found: #{template}" unless File.directory?(template)

    if File.directory?(path)
      abort "Target directory already exists: #{path}. Won't touch."
    else
      Dir.mkdir(path)
    end

    # Parts to be replaced by the user
    replacements = {}

    begin
      # Keep track of what's been created
      created = [path]

      progname = ask!("Program's name")

      Dir.chdir(template) {
        Dir['**/*'].each { |sample|
          target = File.join(path, sample.gsub(/__progname__/, progname))
          created << target

          if File.directory?(sample)
            Dir.mkdir(target)
          else
            content = render(sample, target)
            replacements[target] = content.scan(/### .* ###/)
          end
        }
      }

      # If we got here, everything went fine...
      created.clear
    ensure
      # In case of an exception or premature program exit: Clean up!
      created.reverse.each { |target|
        (File.directory?(target) ? Dir : File).unlink(target)
      }
    end

    puts
    puts "Your new project directory has been created: #{path}"

    replacements.each { |target, parts|
      next if parts.empty?

      puts
      puts "#{target}:"

      parts.each { |part|
        puts "  #{part}"
      }
    }
  when 'list'
    abort 'Sorry, not yet available...'
  else
    abort "Illegal action: #{action}\n#{USAGE}"
end
