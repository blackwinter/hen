#! /usr/bin/ruby

#--
###############################################################################
#                                                                             #
# hen -- Just a Rake helper                                                   #
#                                                                             #
# Copyright (C) 2007-2008 University of Cologne,                              #
#                         Albertus-Magnus-Platz,                              #
#                         50932 Cologne, Germany                              #
#                                                                             #
# Authors:                                                                    #
#     Jens Wille <jens.wille@uni-koeln.de>                                    #
#                                                                             #
# hen is free software; you can redistribute it and/or modify it under the    #
# terms of the GNU General Public License as published by the Free Software   #
# Foundation; either version 3 of the License, or (at your option) any later  #
# version.                                                                    #
#                                                                             #
# hen is distributed in the hope that it will be useful, but WITHOUT ANY      #
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS   #
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more       #
# details.                                                                    #
#                                                                             #
# You should have received a copy of the GNU General Public License along     #
# with hen. If not, see <http://www.gnu.org/licenses/>.                       #
#                                                                             #
###############################################################################
#++

# TODO: Add 'list' - List available hens with their tasks (?)

$: << File.join(File.dirname(__FILE__), '..', 'lib')

require 'hen'
require 'hen/cli'

include Hen::CLI

ACTIONS = {
  'config' => 'Create a fresh .henrc file',
  'create' => 'Create a new project directory tree',
  'list'   => 'List available hens with their tasks'
}

USAGE = <<EOT
Usage: #{$0} {#{ACTIONS.keys.sort.join('|')}}
       #{$0} [-h|--help]
EOT

abort USAGE if ARGV.empty?

case action = ARGV.shift
  when '-h', '--help'
    puts USAGE
    puts
    puts 'Actions:'

    m = ACTIONS.keys.map { |a| a.length }.max

    ACTIONS.sort.each { |a, d|
      puts "  %-#{m}s - %s" % [a, d]
    }
  when 'config'
    henrc = File.join(File.dirname(__FILE__), '..', 'example', '.henrc')

    # TODO: DRY up with lib/hen.rb
    target = File.join(ENV['HOME'] || File.expand_path('~'), '.henrc')

    render(henrc, target)

    puts "Your .henrc has been created: #{target}. Modify to your needs."
  when 'create'
    path = ARGV.shift
    abort 'Path argument missing!' unless path

    abort "Target directory already exists: #{path}. Won't touch." if File.directory?(path)

    rakefile = File.join(File.dirname(__FILE__), '..', 'example', 'Rakefile')
    target   = File.join(path, 'Rakefile')

    # 1. create directory
    Dir.mkdir(path)

    # 2. copy Rakefile
    render(rakefile, target)
  when 'list'
    abort 'Sorry, not yet available...'
  else
    abort "Illegal action: #{action}\n#{USAGE}"
end
